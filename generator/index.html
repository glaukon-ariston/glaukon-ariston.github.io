<!DOCTYPE html>
<meta charset="utf8">
<title>generator :: scratchblocks</title>

<meta name=description content="Make scratchblocks code from your projects. Paste it into forum posts or wiki articles.">

<!--
http://scratchblocks.github.io/generator/

Copyright 2013-2016, Tim Radvan
@license MIT
http://opensource.org/licenses/MIT
-->

<link rel=stylesheet href="//fonts.googleapis.com/css?family=Noto+Sans:400,700">
<link rel="stylesheet" href="../style.css">

<!---------------------------------------------------------------------------->

<div id="header">
  <h1>
    <a href="/">scratchblocks</a> generator
  </h1>

  <div id="url-form">
    <input id="project-url" type="url" size="50"
      value="http://scratch.mit.edu/projects/">
    <br>

    <select id="choose-lang">
      <option value="en">English
      <option value="de"> Deutsch (German)
      <option value="es"> Español (Spanish)
      <option value="fr"> Français (French)
      <option value="zh_CN"> 中文 (Simplified Chinese)
      <option value="pl"> Polski (Polish)
      <option value="ja"> 日本語 (Japanese)
      <option value="nl"> Nederlands (Dutch)
      <option value="pt"> Português (Portugese)
      <option value="it"> Italiano (Italian)
      <option value="he"> עברית (Hebrew)
      <option value="ko"> 한국어 (Korean)
      <option value="nb">Norsk (Norwegian Bokmål) †
      <option value="tr">Türkçe (Turkish)
      <option value="el"> Ελληνικά (Greek)
      <option value="ru"> Pусский (Russian)
      <option value="ca"> Català (Catalan)
      <option value="id">Indonesia (Indonesian)
      <option>———
      <option value="an"> Aragonés (Aragonese)
      <option value="ar"> العربية (Arabic)
      <option value="ast"> Asturianu (Asturian) †
      <option value="bg"> Български (Bulgarian)
      <option value="bn_IN"> বাংলা (Bengali) †
      <option value="cs"> Čeština (Czech)
      <option value="cy"> Cymraeg (Welsh)
      <option value="da"> Dansk (Danish)
      <option value="eo"> Esperanto (Esperanto)
      <option value="et"> Eesti (Estonian)
      <option value="eu"> Euskara (Basque)
      <option value="fa"> فارسی (Persian) *
      <option value="fi"> Suomi (Finnish)
      <option value="fil"> Filipino (Filipino) *
      <option value="fo"> Føroyskt (Faroese) *
      <option value="fr_CA"> Français Canadien (Canadian French) *
      <option value="ga"> Gaeilge (Irish) †
      <option value="gl"> Galego (Galician)
      <option value="hch"> Wixárika (Huichol) *
      <option value="hi"> हिन्दी (Hindi)
      <option value="hr"> Hrvatski (Croatian)
      <option value="ht"> Kreyòl ayisyen (Haitian) *
      <option value="hu"> Magyar (Hungarian)
      <option value="hy"> Հայերեն (Armenian)
      <option value="is"> Íslenska (Icelandic)
      <option value="ja_HIRA"> にほんご (Japanese Hiragana)
      <option value="kk"> Қазақша (Kazakh) *
      <option value="km"> ភាសាខ្មែរ (Khmer) *
      <option value="kn"> ಕನ್ನಡ (Kannada)
      <option value="ku"> Kurdî / كوردی (Kurdish) *
      <option value="ky"> Кыргызча (Kyrgyz) †
      <option value="la"> Latina (Latin) *
      <option value="lt"> Lietuvių (Lithuanian)
      <option value="lv"> Latviešu (Latvian) †
      <option value="maz"> Jñatjo (Mazahua) *
      <option value="mk"> Македонски (Macedonian)
      <option value="ml"> മലയാളം (Malayalam) *
      <option value="mn"> Монгол (Mongolian) *
      <option value="mr"> मराठी (Marathi) *
      <option value="ms"> Bahasa Melayu (Malay) *
      <option value="my"> ဗမာစာ (Burmese)
      <option value="nah"> Nāhuatl (Nahuatl) *
      <option value="ne"> नेपाली (Nepali) *
      <option value="nn"> Nynorsk (Norwegian Nynorsk) †
      <option value="no"> Norsk (Norwegian)
      <option value="os"> Иронау (Ossetian) †
      <option value="ote"> Hñähñu (Mezquital Otomi) *
      <option value="oto"> Hñähñu (Otomi) *
      <option value="pap"> Idoma-Nòmber (Idoma) *
      <option value="pt_BR"> Português brasileiro (Brazilian Portuguese)
      <option value="ro"> Română (Romanian)
      <option value="rw"> Ikinyarwanda (Kinyarwanda) *
      <option value="sk"> Slovenčina (Slovak)
      <option value="sl"> Slovenščina (Slovene)
      <option value="sr"> Српски / Srpski (Serbian)
      <option value="sv"> Svenska (Swedish)
      <option value="sw"> Kiswahili (Swahili) *
      <option value="ta"> தமிழ் (Tamil) †
      <option value="th"> ไทย (Thai) *
      <option value="tzm"> Tamaziġt (Tamazight) †
      <option value="ug"> ئۇيغۇر تىلى (Uyghur) *
      <option value="uk"> Українська (Ukrainian)
      <option value="vi"> Tiếng Việt (Vietnamese)
      <option value="zh_TW"> 正體中文 (Traditional Chinese)
    </select>

    <b id="status"></b>
  </div>
</div>

<div id="wrap">
  <div id="intro">
    <p><strong>The generator is deprecated since the release of Scratch 3.0.</strong> It will only work for Scratch 2.0 projects.
    <p>Makes scratchblocks code from your projects. Paste it into
    <a href="http://scratch.mit.edu/forums/viewtopic.php?id=90403">Scratch
    Forum</a> posts or <a href="http://wiki.scratch.mit.edu/wiki/Block_Plugin">
    Scratch Wiki</a> articles.

    </p>
  </div>

  <div id="sprite-detail">
    <div class="sprite-info">
      <h2 class="sprite-name"></h2>
      <div class="costume-preview"><img></div>
    </div>
    <div class="scripts-list"></div>
  </div>

  <div id="project">
    <h1 class="project-name">-</h1>
    <div>Project ID: <span class="projectId">0</span></div>
    <div>Author: <span class="author">-</span></div>
    <div>Scratch-Version: <span class="scratch-version">-</span></div>
    <div>Script Count: <span class="scriptCount">-</span></div>
    <div>Sprite Count: <span class="spriteCount">-</span></div>
    <div>Comment: <span class="comment">-</span></div>
  </div>
  <div id="all-sprites">
  </div>
</div>


<!---------------------------------------------------------------------------->

<script src="/js/scratchblocks-v3.3-min.js"></script>
<script src="/js/translations-all-v3.3.js"></script>

<script>
var current_id,
  selected_sprite,
  sprites,
  fetching = false,
  scripts_by_id,
  chosen_scripts,
  lang;

var statusLabel = document.querySelector("#status")
var projectInput = document.querySelector("#project-url")
var langOption = document.querySelector("#choose-lang")

function asset_url (md5) {
  return "//cdn.scratch.mit.edu/internalapi/asset/" + md5 + "/get/";
}

function id_from_url (url) {
  url = url.replace(/-[0-9]+/g, ''); // Remove numbers in comment anchors
  var id = url.match(/[0-9]+(?![\s\S]*[0-9]+)/); // Find the last number in the url
  return id;
}

function fetchProject(id) {
  projectInput.value = "http://scratch.mit.edu/projects/"+id
  current_id = id;

  var url = "https://projects.scratch.mit.edu/" + id + "";

  clear_project();

  fetching = true;

  statusLabel.textContent = "Fetching...";

  fetch(url, {
  }).then(function(response) {
    return response.text()
  }).then(function(text) {
    var isLegacy = /^ScratchV01/.test(text)
    if (isLegacy) {
      throw "Scratch 1.4 projects not supported"
    }

    var json = JSON.parse(text)
    window.project = json; // DEBUG

    statusLabel.textContent = "Loading...";
    load_project(json);
    statusLabel.textContent = "Done!";
    fetching = false;
    projectInput.blur();
  })
    /*.catch(function(err) {
    statusLabel.textContent = "Error: "+err;
    fetching = false;
    check_hash();
    projectInput.focus();
  });*/
}

function clear_project () {
  document.querySelector("#all-sprites").innerHTML = ""
}

function load_project (project) {
  if (project.meta && project.meta.semver) {
    throw new Error("Scratch 3 projects not supported")
  }

  var sprites_list = [project] // stage
    .concat(project.children);

  sprites_list = sprites_list.filter(function(sprite) {
    return sprite.hasOwnProperty("objName");
  });

  // clear stuff
  sprites = {};
  scripts_by_id = {};
  chosen_scripts = [];

  sprites_list.forEach(function(sprite, i) {
    sprites[i] = sprite;
  })

  selected_sprite = 0;
  var hash = decodeURIComponent((location.href.split("#")[1] || ""));
  var result = /sprite=([0-9]+)/.exec(hash);
  if (result) {
    var selected_sprite = result[1];
  }

  document.querySelector("#intro").classList.add("hidden");
  show_all_sprites(project);
  check_hash();
}

function show_sprite(i) {
  var sprite = sprites[i];
  if (!sprite) {
    return;
  }

  var name = sprite.objName;

  let sprite_detail_id = 'sprite-detail-'+i;
  let details = document.querySelector('#sprite-detail').cloneNode(true);
  // Change the id attribute of the newly created element:
  details.setAttribute('id', sprite_detail_id);
  document.querySelector('#all-sprites').appendChild(details);

  // title
  details.querySelector(".sprite-name").textContent = name;
  // preview image
  var costume = sprite.costumes[sprite.currentCostumeIndex];
  if (costume && costume.baseLayerMD5) {
    details.querySelector(".costume-preview img").src = asset_url(costume.baseLayerMD5);
  }

  // scripts
  details.querySelector(".scripts-list").innerHTML = "";
  if (!sprite.scripts) {
    var emptyState = document.createElement("p")
    emptyState.textContent = "No scripts."
    details.querySelector(".scripts-list").appendChild(emptyState)
  } else {
    var highest_script_id = 1;

    /* sort by y position */
    sprite.scripts = sprite.scripts.sort(function (a, b) {
      return a[1] - b[1];
    });

    var doc = scratchblocks.fromJSON(sprite, scratchblocks.allLanguages[lang]);

    doc.scripts.forEach(function(script) {
      var code = script.stringify();
      console.log(code);

      var wrapEl = document.createElement("div")
      wrapEl.className = "script-wrap"
      details.querySelector(".scripts-list").appendChild(wrapEl);

      var scriptDoc = new scratchblocks.Document([script]);
      var docView = scratchblocks.newView(scriptDoc, {
        style: "scratch3",
      })
      var svg = docView.render()
      svg.style.transform = 'scale(0.675)'
      svg.style.transformOrigin = '0 0'

      var label = document.createElement("label")
      label.for = id
      label.style.height = ((docView.height * 0.675)|0) + 'px';
      label.style.display = 'block'
      label.appendChild(svg);
      wrapEl.appendChild(label)

      var id = highest_script_id;
      var key = selected_sprite + "-" + highest_script_id;
      scripts_by_id[key] = code;
      highest_script_id += 1;
    });
  }

  // DEBUG
  window.sprite = sprite;
}


function show_all_sprites(project) {
  let projectInfo = document.querySelector("project");
  projectInfo.querySelector("project-name").textContent = project['info']['projectId'];
  projectInfo.querySelector("projectId").textContent = project['info']['projectId'];
  projectInfo.querySelector("author").textContent = project['info']['author'];
  projectInfo.querySelector("scratch-version").textContent = project['info']['scratch-version'];
  projectInfo.querySelector("scriptCount").textContent = project['info']['scriptCount'];
  projectInfo.querySelector("spriteCount").textContent = project['info']['spriteCount'];
  projectInfo.querySelector("comment").textContent = project['info']['comment'];

  for (const [key, value] of Object.entries(sprites)) {
    show_sprite(key);
  }
}


function chosen_scripts_updated () {
  document.querySelector("#num-chosen-scripts").textContent = chosen_scripts.length;
  if (chosen_scripts.length) {
    var code = export_code();
    //var url = "http://scratchblocks.github.io/#";
    var url = "/#";
    if (lang && lang !== "en") url += "?lang=" + lang + "&script=";
    url += encodeURIComponent(code);
    document.querySelector("#export").href = url
    document.querySelector("#export").classList.remove("disabled");
  } else {
    document.querySelector("#export").href = ""
    document.querySelector("#export").classList.add("disabled");
  }
}

function export_code () {
  out = "";
  chosen_scripts.forEach(function(id) {
    out += scripts_by_id[id];
    out += "\n\n";
  })
  return out.trim();
}

function init_fetch () {
  projectInput.blur();


  lang = langOption.value || "en";

  var id = id_from_url(projectInput.value);
  if (id) {
    location.hash = "#project="+id;
    fetchProject(id);
  } else {
    statusLabel.textContent = "Invalid URL";
  }
}

function check_hash() {
  if (fetching) return;

  var hash = decodeURIComponent((location.href.split("#")[1] || ""));

  var result = /url=([^&]*)/.exec(hash);
  if (result) {
    projectInput.value = decodeURIComponent(result[1]);
    init_fetch();
    return;
  }

  var result = /project=([0-9]+)/.exec(hash);
  if (result) {
    if (result[1] != current_id) {
      fetchProject(result[1]);
    } else {
      // todo: clear?
    }
  }

  var result = /sprite=([0-9]+)/.exec(hash);
  if (result) {
    if (result[1] != selected_sprite) {
      show_sprite(result[1]);
    }
  }

  window.setTimeout(check_hash, 500);
}


var input = document.getElementById('project-url');
input.addEventListener('input', function(e) {
  console.log(input.value);
  var id = id_from_url(input.value);
  input.value = "http://scratch.mit.edu/projects/" + (id || '');
  console.log(id);
});

projectInput.addEventListener("keypress", function (e) {
  if (e.which == 13) {
    init_fetch();
  }
});

langOption.addEventListener("change", function (e) {
  init_fetch();
});


document.addEventListener("keydown", function (e) {
  if (e.ctrlKey) {
    switch (e.which) {
      case 38:
        show_sprite(selected_sprite - 1);
        e.preventDefault();
        return false;

      case 40:
        show_sprite(selected_sprite + 1);
        e.preventDefault();
        return false;
    }
  }
});

projectInput.focus() //.val(projectInput.val()); // set cursor to end

clear_project(); // make sure we start fresh

check_hash();
</script>
<script>
  !function(g,s,q,r,d){r=g[r]=g[r]||function(){(r.q=r.q||[]).push(
  arguments)};d=s.createElement(q);q=s.getElementsByTagName(q)[0];
  d.src='//d1l6p2sc9645hc.cloudfront.net/tracker.js';q.parentNode.
  insertBefore(d,q)}(window,document,'script','_gs');

  _gs('GSN-349113-Y');
</script>

